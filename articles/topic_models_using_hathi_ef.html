<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Topic Modeling using the Hathi Trust Extracted Features Files • hathiTools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Topic Modeling using the Hathi Trust Extracted Features Files">
<meta property="og:description" content="hathiTools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hathiTools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example_workflow.html">An Example Workflow</a>
    </li>
    <li>
      <a href="../articles/topic_models_using_hathi_ef.html">Topic Modeling using the Hathi Trust Extracted Features Files</a>
    </li>
    <li>
      <a href="../articles/using_the_hathi_bookworm.html">Using the Hathi Trust Bookworm Tool</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/xmarquez/hathiTools/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="topic_models_using_hathi_ef_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Topic Modeling using the Hathi Trust Extracted Features Files</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/xmarquez/hathiTools/blob/HEAD/vignettes/articles/topic_models_using_hathi_ef.Rmd" class="external-link"><code>vignettes/articles/topic_models_using_hathi_ef.Rmd</code></a></small>
      <div class="hidden name"><code>topic_models_using_hathi_ef.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="topic-modeling-using-the-hathi-trust-extracted-features-files">Topic Modeling using the Hathi Trust Extracted Features Files<a class="anchor" aria-label="anchor" href="#topic-modeling-using-the-hathi-trust-extracted-features-files"></a>
</h2>
<p>The Hathi Trust digital library makes available “extracted features” files (files with per-page word count and part of speech information) for millions of digitized volumes from large research libraries. One attraction of these files is that even though they do not contain the full text of each page, page-level “bags of words” are more than sufficient for a vast variety of tasks in the Digital Humanities, from topic modeling to basic word vector models to predictive models. This vignette explains how one can use these files to do basic topic modeling of many volumes.</p>
<div class="section level3">
<h3 id="an-example-a-page-level-topic-model-of-different-editions-of-tocquevilles-democracy-in-america">An example: A page-level topic model of different editions of Tocqueville’s <em>Democracy in America</em><a class="anchor" aria-label="anchor" href="#an-example-a-page-level-topic-model-of-different-editions-of-tocquevilles-democracy-in-america"></a>
</h3>
<p>Alexis de Tocqueville’s <em>Democracy in America</em> is a very influential text. Ever since its original publication in 1835, it has been translated into multiple languages and republished many times. In this vignette, we use the Hathi Trust extracted features files of its many editions to train a page-level topic model that can help visualize how these translations and editions vary.</p>
<div class="section level4">
<h4 id="selecting-the-sample">Selecting the sample<a class="anchor" aria-label="anchor" href="#selecting-the-sample"></a>
</h4>
<p>As a starting point, we can download the IDs of all volumes where Alexis the Tocqueville appears as an author in the 17 million volumes indexed by the Hathi Trust <a href="https://solr2.htrc.illinois.edu/solr-ef/" class="external-link">Workset Builder</a>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/xmarquez/hathiTools" class="external-link">hathiTools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://arxiv.org/abs/1403.2805" class="external-link">jsonlite</a></span><span class="op">)</span> <span class="co"># For processing some results</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.structuraltopicmodel.com/" class="external-link">stm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">tocqueville</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workset_builder.html">workset_builder</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Alexis de Tocqueville"</span><span class="op">)</span></span>
<span><span class="va">tocqueville</span></span>
<span><span class="co">#&gt; # A tibble: 464 × 2</span></span>
<span><span class="co">#&gt;    htid                   n</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;              &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1 mdp.39015079304757  1358</span></span>
<span><span class="co">#&gt;  2 mdp.39015008706338  1213</span></span>
<span><span class="co">#&gt;  3 mdp.39015058109706   945</span></span>
<span><span class="co">#&gt;  4 nyp.33433081795357   910</span></span>
<span><span class="co">#&gt;  5 uva.x000469924       909</span></span>
<span><span class="co">#&gt;  6 hvd.32044051720316   906</span></span>
<span><span class="co">#&gt;  7 coo.31924030454809   904</span></span>
<span><span class="co">#&gt;  8 nyp.33433081795266   903</span></span>
<span><span class="co">#&gt;  9 ien.35556041207515   901</span></span>
<span><span class="co">#&gt; 10 nyp.33433081795381   901</span></span>
<span><span class="co">#&gt; # … with 454 more rows</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span></code></pre></div>
<p>There are over 400 volumes which list Tocqueville as an author. Many of these are the same, but digitised from different libraries, or different editions of the same text, and some are in different languages (French and English, for example). We can get a glimpse of the variety by downloading the metadata for a sample of 20 volumes:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">14</span><span class="op">)</span></span>
<span><span class="va">tocqueville_meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_workset_meta.html">get_workset_meta</a></span><span class="op">(</span><span class="va">tocqueville</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                                       <span class="fu">slice_sample</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tocqueville_meta</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">title</span>, <span class="va">pubDate</span>, <span class="va">publisher</span>, <span class="va">contributor</span>, <span class="va">language</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">rowwise</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>publisher <span class="op">=</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">publisher</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">pluck</span><span class="op">(</span><span class="st">"name"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         contributor <span class="op">=</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">contributor</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">pluck</span><span class="op">(</span><span class="st">"name"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="40%">
<col width="2%">
<col width="20%">
<col width="30%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="left">title</th>
<th align="right">pubDate</th>
<th align="left">publisher</th>
<th align="left">contributor</th>
<th align="left">language</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Democracy in America.</td>
<td align="right">1862</td>
<td align="left">Longman, Green, Longman, and Roberts</td>
<td align="left">Tocqueville, Alexis de, 1805-1859., Reeve, Henry, 1813-1895.</td>
<td align="left">eng</td>
</tr>
<tr class="even">
<td align="left">Système pénitentiaire aux États-Unis et de son application en France; suivi d’un appendice sur les colonies pénales, et de notes statistiques,</td>
<td align="right">1845</td>
<td align="left">C. Gosselin</td>
<td align="left">Beaumont, Gustave de, 1802-1866. , Tocqueville, Alexis de, 1805-1859</td>
<td align="left">fre</td>
</tr>
<tr class="odd">
<td align="left">Œuvres complètes d’Alexis de Tocqueville,</td>
<td align="right">1877</td>
<td align="left">Michel Lévy frères</td>
<td align="left">Tocqueville, Alexis de, 1805-1859., Tocqueville, Mary Mottley,</td>
<td align="left">fre</td>
</tr>
<tr class="even">
<td align="left">L’Ancien Régime.</td>
<td align="right">1904</td>
<td align="left">Clarendon Press</td>
<td align="left">Tocqueville, Alexis de, 1805-1859., Headlam, G. W.</td>
<td align="left">fre</td>
</tr>
<tr class="odd">
<td align="left">On the penitentiary system in the United States and its application in France /</td>
<td align="right">1979</td>
<td align="left">Southern Illinois University Press</td>
<td align="left">Beaumont, Gustave de, 1802-1866. , Tocqueville, Alexis de, 1805-1859,</td>
<td align="left">eng</td>
</tr>
<tr class="even">
<td align="left">Democracy in America.</td>
<td align="right">1839</td>
<td align="left">G. Adlard</td>
<td align="left">Tocqueville, Alexis de, 1805-1859. , Spencer, John C. (John Canfield), 1788-1855,, Reeve, Henry, 1813-1895,</td>
<td align="left">eng</td>
</tr>
<tr class="odd">
<td align="left">Oeuvres et correspondance inédites d’Alexis de Tocqueville /</td>
<td align="right">1861</td>
<td align="left">Michel Lévy Frères, Impr. de J. Claye</td>
<td align="left">Tocqueville, Alexis de, 1805-1859., Beaumont, Gustave de, 1802-1866,</td>
<td align="left">fre</td>
</tr>
<tr class="even">
<td align="left">Egalité sociale et liberté politique : une introduction à l’œuvre de Tocqueville /</td>
<td align="right">1977</td>
<td align="left">Aubier-Montaigne</td>
<td align="left">Tocqueville, Alexis de, 1805-1859, Gibert, Pierre</td>
<td align="left">fre</td>
</tr>
<tr class="odd">
<td align="left">American institutions …</td>
<td align="right">1874</td>
<td align="left">John Allyn</td>
<td align="left">Tocqueville, Alexis de, 1805-1859., Reeve, Henry, 1813-1895.</td>
<td align="left"><span class="math display">\[“eng”,“fre”\]</span></td>
</tr>
<tr class="even">
<td align="left">Œuvres complètes.</td>
<td align="right">1952</td>
<td align="left">Gallimard</td>
<td align="left">Tocqueville, Alexis de, 1805-1859.</td>
<td align="left">fre</td>
</tr>
<tr class="odd">
<td align="left">Œuvres, papiers et correspondances.</td>
<td align="right">1951</td>
<td align="left">Gallimard</td>
<td align="left">Tocqueville, Alexis de, 1805-1859. , Mayer, J. P. (Jacob Peter), 1903-1992</td>
<td align="left">fre</td>
</tr>
<tr class="even">
<td align="left">Democracy in America,</td>
<td align="right">1838</td>
<td align="left">Adlard and Saunders, 46 Broadway; George Dearborn &amp; Co., 38 Gold Street</td>
<td align="left">Tocqueville, Alexis de, 1805-1859. , Spencer, John C. (John Canfield), 1788-1855,, Reeve, Henry, 1813-1895,</td>
<td align="left"><span class="math display">\[“eng”,“fre”\]</span></td>
</tr>
<tr class="odd">
<td align="left">Recollections.</td>
<td align="right">1970</td>
<td align="left">Doubleday</td>
<td align="left">Tocqueville, Alexis de, 1805-1859.</td>
<td align="left"><span class="math display">\[“eng”,“fre”\]</span></td>
</tr>
<tr class="even">
<td align="left">Democracy in America: part the second : the social influence of democracy /</td>
<td align="right">1840</td>
<td align="left">J. &amp; H. G. Langley; Philadelphia, Thomas, Cowperthwaite &amp; Co. etc.</td>
<td align="left">Tocqueville, Alexis de, 1805-1859. , Spencer, John C. (John Canfield), 1788-1855,, Reeve, Henry, 1813-1895,</td>
<td align="left">eng</td>
</tr>
<tr class="odd">
<td align="left">Œuvres complètes.</td>
<td align="right">1952</td>
<td align="left">Gallimard</td>
<td align="left">Tocqueville, Alexis de, 1805-1859.</td>
<td align="left">fre</td>
</tr>
<tr class="even">
<td align="left">Œuvres, papiers et correspondances.</td>
<td align="right">1951</td>
<td align="left">Gallimard</td>
<td align="left">Tocqueville, Alexis de, 1805-1859. , Mayer, J. P. (Jacob Peter), 1903-1992</td>
<td align="left">fre</td>
</tr>
<tr class="odd">
<td align="left">Oeuvres /</td>
<td align="right">1991</td>
<td align="left">Gallimard</td>
<td align="left">Tocqueville, Alexis de, 1805-1859., Jardin, André, 1912-</td>
<td align="left">fre</td>
</tr>
<tr class="even">
<td align="left">Oeuvres complètes /</td>
<td align="right">1866</td>
<td align="left">publisher not identified</td>
<td align="left">Tocqueville, Alexis de, 1805-1859., Beaumont, Gustave de, 1802-1866. , Tocqueville, Mary Mottley.</td>
<td align="left">fre</td>
</tr>
<tr class="odd">
<td align="left">De la démocratie en Amérique /</td>
<td align="right">1990</td>
<td align="left">J. Vrin</td>
<td align="left">Tocqueville, Alexis de, 1805-1859., Nolla, Eduardo.</td>
<td align="left">fre</td>
</tr>
<tr class="even">
<td align="left">De la démocratie en Amérique … et augmentée … d’un examen comparatif de la démocratie aux États-Unis et en Suisse.</td>
<td align="right">1848</td>
<td align="left">Pagnerre</td>
<td align="left">Tocqueville, Alexis de, 1805-1859.</td>
<td align="left">fre</td>
</tr>
</tbody>
</table>
<p>(Note that you normally won’t want to be using <code><a href="../reference/get_workset_meta.html">get_workset_meta()</a></code> for more than 100 or so volumes - it will take a long time; best to cache the files locally and then extract their metadata, as explained in <code>[the example workflow vignette](vignette("example_workflow"))</code>).</p>
<p>The function <code><a href="../reference/workset_builder.html">workset_builder()</a></code> by default returns a data frame with column for the Hathi Trust id and a column for how many times the <code>token</code> key is mentioned; since we didn’t include any tokens to search for in our query, the function just returned the number of pages in each volume. If we instead search for the volumes where Tocqueville is an author that <em>also</em> mention the word “democracy”, the function returns both the volume id and the number of pages that contain the term.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tocqueville2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workset_builder.html">workset_builder</a></span><span class="op">(</span><span class="st">"democracy"</span>, name <span class="op">=</span> <span class="st">"Alexis de Tocqueville"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tocqueville2</span></span>
<span><span class="co">#&gt; # A tibble: 239 × 2</span></span>
<span><span class="co">#&gt;    htid                    n</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;               &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1 uc1.b3987464          239</span></span>
<span><span class="co">#&gt;  2 mdp.39015058109706    214</span></span>
<span><span class="co">#&gt;  3 uva.x000469924        201</span></span>
<span><span class="co">#&gt;  4 uva.x001179573        201</span></span>
<span><span class="co">#&gt;  5 hvd.32044051720316    200</span></span>
<span><span class="co">#&gt;  6 nyp.33433081795266    200</span></span>
<span><span class="co">#&gt;  7 nyp.33433081795357    200</span></span>
<span><span class="co">#&gt;  8 nyp.33433081795381    200</span></span>
<span><span class="co">#&gt;  9 umn.319510019923684   200</span></span>
<span><span class="co">#&gt; 10 hvd.hn2ul5            199</span></span>
<span><span class="co">#&gt; # … with 229 more rows</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span></code></pre></div>
<p>This is a smaller workset, since it only includes English tokens, and only volumes by Tocqueville that include the word “democracy” (most of them!). It’s also possible to get the exact page sequence numbers where the term appears:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tocqueville3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workset_builder.html">workset_builder</a></span><span class="op">(</span><span class="st">"democracy"</span>, name <span class="op">=</span> <span class="st">"Alexis de Tocqueville"</span>, volumes_only <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tocqueville3</span></span>
<span><span class="co">#&gt; # A tibble: 17,278 × 2</span></span>
<span><span class="co">#&gt;    htid                     id                                  </span></span>
<span><span class="co">#&gt;    &lt;chr&gt;                    &lt;chr&gt;                               </span></span>
<span><span class="co">#&gt;  1 aeu.ark:/13960/t0wq0sh3s aeu.ark:/13960/t0wq0sh3s.page-000118</span></span>
<span><span class="co">#&gt;  2 aeu.ark:/13960/t0wq0sh3s aeu.ark:/13960/t0wq0sh3s.page-000205</span></span>
<span><span class="co">#&gt;  3 aeu.ark:/13960/t0wq0sh3s aeu.ark:/13960/t0wq0sh3s.page-000083</span></span>
<span><span class="co">#&gt;  4 aeu.ark:/13960/t0wq0sh3s aeu.ark:/13960/t0wq0sh3s.page-000199</span></span>
<span><span class="co">#&gt;  5 aeu.ark:/13960/t0wq0sh3s aeu.ark:/13960/t0wq0sh3s.page-000249</span></span>
<span><span class="co">#&gt;  6 aeu.ark:/13960/t0wq0sh3s aeu.ark:/13960/t0wq0sh3s.page-000192</span></span>
<span><span class="co">#&gt;  7 aeu.ark:/13960/t0wq0sh3s aeu.ark:/13960/t0wq0sh3s.page-000102</span></span>
<span><span class="co">#&gt;  8 aeu.ark:/13960/t0wq0sh3s aeu.ark:/13960/t0wq0sh3s.page-000124</span></span>
<span><span class="co">#&gt;  9 aeu.ark:/13960/t0wq0sh3s aeu.ark:/13960/t0wq0sh3s.page-000149</span></span>
<span><span class="co">#&gt; 10 aeu.ark:/13960/t0wq0sh3s aeu.ark:/13960/t0wq0sh3s.page-000247</span></span>
<span><span class="co">#&gt; # … with 17,268 more rows</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span></code></pre></div>
<p>We can browse any of these pages interactively on the Hathi Trust website, just to get a sense of what they look like. (Most will be in the public domain; note that the page sequences are zero-indexed, so they are one less than the actual page shown on the Hathi Trust website).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/browse_htids.html">browse_htids</a></span><span class="op">(</span><span class="va">tocqueville3</span><span class="op">)</span></span></code></pre></div>
<p>For our topic modeling exercise, we will focus on volumes of Tocqueville published since 1950 (better OCR!) with “Democracy in America” in the title.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tocqueville4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workset_builder.html">workset_builder</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Alexis de Tocqueville"</span>, pub_date <span class="op">=</span> <span class="fl">1950</span><span class="op">:</span><span class="fl">2020</span>, title <span class="op">=</span> <span class="st">"Democracy in America"</span><span class="op">)</span></span>
<span><span class="va">tocqueville4</span></span>
<span><span class="co">#&gt; # A tibble: 27 × 2</span></span>
<span><span class="co">#&gt;    htid                   n</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;              &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1 mdp.39015058109706   945</span></span>
<span><span class="co">#&gt;  2 ien.35556040838641   845</span></span>
<span><span class="co">#&gt;  3 uc1.b3987464         781</span></span>
<span><span class="co">#&gt;  4 mdp.39015059568017   667</span></span>
<span><span class="co">#&gt;  5 uva.x000918570       627</span></span>
<span><span class="co">#&gt;  6 uva.x000843187       622</span></span>
<span><span class="co">#&gt;  7 uc1.32106006021593   610</span></span>
<span><span class="co">#&gt;  8 uc1.31158011108353   589</span></span>
<span><span class="co">#&gt;  9 uc1.32106009996031   566</span></span>
<span><span class="co">#&gt; 10 mdp.39015001795965   563</span></span>
<span><span class="co">#&gt; # … with 17 more rows</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span></code></pre></div>
<p>In principle we can download their full metadata using the function get_workset_meta(), though the SOLR service hasn’t been working recently. (Also, it’s a slow download, so use with care if you have a lot of Hathi Trust ids!).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tocqueville_meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_workset_meta.html">get_workset_meta</a></span><span class="op">(</span><span class="va">tocqueville4</span><span class="op">)</span></span>
<span><span class="va">tocqueville_meta</span></span>
<span><span class="co">#&gt; # A tibble: 27 × 16</span></span>
<span><span class="co">#&gt;    htid      acces…¹ acces…² url   title dateC…³ lastR…⁴ pubDate schem…⁵ typeO…⁶</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;  </span></span>
<span><span class="co">#&gt;  1 mdp.3901… google  ic      http… Demo…  2.02e7  2.02e7    2004 https:… http:/…</span></span>
<span><span class="co">#&gt;  2 ien.3555… google  ic      http… Demo…  2.02e7  2.02e7    2010 https:… http:/…</span></span>
<span><span class="co">#&gt;  3 uc1.b398… google  ic      http… Demo…  2.02e7  2.02e7    1969 https:… http:/…</span></span>
<span><span class="co">#&gt;  4 mdp.3901… google  ic      http… Demo…  2.02e7  2.02e7    1981 https:… http:/…</span></span>
<span><span class="co">#&gt;  5 uva.x000… google  ic      http… Demo…  2.02e7  2.02e7    1952 https:… http:/…</span></span>
<span><span class="co">#&gt;  6 uva.x000… google  ic      http… Demo…  2.02e7  2.02e7    1959 https:… http:/…</span></span>
<span><span class="co">#&gt;  7 uc1.3210… google  und     http… Demo…  2.02e7  2.02e7    1961 https:… http:/…</span></span>
<span><span class="co">#&gt;  8 uc1.3115… google  pdus    http… Demo…  2.02e7  2.02e7    1986 https:… http:/…</span></span>
<span><span class="co">#&gt;  9 uc1.3210… google  ic      http… Demo…  2.02e7  2.02e7    1980 https:… http:/…</span></span>
<span><span class="co">#&gt; 10 mdp.3901… google  ic      http… Demo…  2.02e7  2.02e7    1980 https:… http:/…</span></span>
<span><span class="co">#&gt; # … with 17 more rows, 6 more variables: language &lt;chr&gt;, oclc &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   genre &lt;chr&gt;, contributor &lt;chr&gt;, publisher &lt;chr&gt;, pubPlace &lt;chr&gt;, and</span></span>
<span><span class="co">#&gt; #   abbreviated variable names ¹​accessProfile, ²​accessRights, ³​dateCreated,</span></span>
<span><span class="co">#&gt; #   ⁴​lastRightsUpdateDate, ⁵​schemaVersion, ⁶​typeOfResource</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names</span></span></code></pre></div>
<p>There are 27 volumes listed here, but many are the same book; sometimes the title has just been entered slightly differently in different cataloguing systems, or republished multiple times, or it’s another volume of the same edition. We find 14 distinct bibliographical records with 14 distinct titles which we can investigate:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tocqueville_meta</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>n_records <span class="op">=</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">htid</span><span class="op">)</span>,</span>
<span>            n_titles <span class="op">=</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">title</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 2</span></span>
<span><span class="co">#&gt;   n_records n_titles</span></span>
<span><span class="co">#&gt;       &lt;int&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1        27        5</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="downloading-and-caching-the-associated-extracted-features-files">Downloading and caching the associated Extracted Features files<a class="anchor" aria-label="anchor" href="#downloading-and-caching-the-associated-extracted-features-files"></a>
</h4>
<p>We first download the “extracted features” files for these texts through the Hathi Trust rsync server. The <code><a href="../reference/rsync_from_hathi.html">rsync_from_hathi()</a></code> function attempts to do this automatically (to the <code>"./hathi-ef"</code> directory by default, which will be created if it doesn’t exist; this is the default option ). This function requires that your system has access to <code>rsync</code>. (In Windows, the easiest way to do this is to install the <a href="https://docs.microsoft.com/en-us/windows/wsl/install" class="external-link">Windows Subsystem for Linux</a>; <code>rsync</code> should come already installed in most Mac and Linux machines).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The current directory for caching:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"hathiTools.ef.dir"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "./hathi-ef"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/rsync_from_hathi.html">rsync_from_hathi</a></span><span class="op">(</span><span class="va">tocqueville4</span><span class="op">)</span></span>
<span><span class="co">#&gt; 0</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>The downloaded files are in JSON format, which is slow to load and parse into data frames. We can cache these files to fast-loading CSVs (or to other formats, including <strong>Feather</strong> or <strong>Parquet</strong> formats from the {arrow} package) in the <code>"./hathi-ef"</code> directory also using the function <code><a href="../reference/cache_htids.html">cache_htids()</a></code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cached_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cache_htids.html">cache_htids</a></span><span class="op">(</span><span class="va">tocqueville4</span><span class="op">)</span></span>
<span><span class="va">cached_files</span></span>
<span><span class="co">#&gt; # A tibble: 81 × 5</span></span>
<span><span class="co">#&gt;    htid               local_loc                           cache…¹ cache…² exists</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;              &lt;glue&gt;                              &lt;chr&gt;   &lt;chr&gt;   &lt;lgl&gt; </span></span>
<span><span class="co">#&gt;  1 mdp.39015058109706 ./hathi-ef/mdp/31500/mdp.390150581… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  2 ien.35556040838641 ./hathi-ef/ien/35434/ien.355560408… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  3 uc1.b3987464       ./hathi-ef/uc1/b86/uc1.b3987464.cs… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  4 mdp.39015059568017 ./hathi-ef/mdp/31561/mdp.390150595… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  5 uva.x000918570     ./hathi-ef/uva/x080/uva.x000918570… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  6 uva.x000843187     ./hathi-ef/uva/x037/uva.x000843187… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  7 uc1.32106006021593 ./hathi-ef/uc1/30029/uc1.321060060… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  8 uc1.31158011108353 ./hathi-ef/uc1/35105/uc1.311580111… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  9 uc1.32106009996031 ./hathi-ef/uc1/30093/uc1.321060099… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt; 10 mdp.39015001795965 ./hathi-ef/mdp/31096/mdp.390150017… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt; # … with 71 more rows, and abbreviated variable names ¹​cache_format,</span></span>
<span><span class="co">#&gt; #   ²​cache_type</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span></code></pre></div>
<p>The convenience function <code><a href="../reference/find_cached_htids.html">find_cached_htids()</a></code>, when called with a vector of Hathi Trust IDs or a workset, returns a data frame with the Hathi Trust id, the local file paths of the cached EF files, and whether each file exists or not (i.e., whether it was downloaded successfully and cached).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cached_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_cached_htids.html">find_cached_htids</a></span><span class="op">(</span><span class="va">tocqueville4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cached_files</span></span>
<span><span class="co">#&gt; # A tibble: 81 × 5</span></span>
<span><span class="co">#&gt;    htid               local_loc                           cache…¹ cache…² exists</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;              &lt;glue&gt;                              &lt;chr&gt;   &lt;chr&gt;   &lt;lgl&gt; </span></span>
<span><span class="co">#&gt;  1 mdp.39015058109706 ./hathi-ef/mdp/31500/mdp.390150581… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  2 ien.35556040838641 ./hathi-ef/ien/35434/ien.355560408… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  3 uc1.b3987464       ./hathi-ef/uc1/b86/uc1.b3987464.cs… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  4 mdp.39015059568017 ./hathi-ef/mdp/31561/mdp.390150595… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  5 uva.x000918570     ./hathi-ef/uva/x080/uva.x000918570… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  6 uva.x000843187     ./hathi-ef/uva/x037/uva.x000843187… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  7 uc1.32106006021593 ./hathi-ef/uc1/30029/uc1.321060060… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  8 uc1.31158011108353 ./hathi-ef/uc1/35105/uc1.311580111… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt;  9 uc1.32106009996031 ./hathi-ef/uc1/30093/uc1.321060099… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt; 10 mdp.39015001795965 ./hathi-ef/mdp/31096/mdp.390150017… csv.gz  ef      TRUE  </span></span>
<span><span class="co">#&gt; # … with 71 more rows, and abbreviated variable names ¹​cache_format,</span></span>
<span><span class="co">#&gt; #   ²​cache_type</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span></code></pre></div>
<p>These files can now be loaded into R very quickly:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tocqueville_ef</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_cached_htids.html">read_cached_htids</a></span><span class="op">(</span><span class="va">tocqueville4</span><span class="op">)</span></span>
<span><span class="va">tocqueville_ef</span></span>
<span><span class="co">#&gt; # A tibble: 3,318,779 × 44</span></span>
<span><span class="co">#&gt;    htid        token POS   count section  page schem…¹ id    type  dateC…² title</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt;   &lt;int&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;int&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt;  1 mdp.390150… ALEX… UNK       1 body        5 https:… http… "[[\…  2.02e7 Demo…</span></span>
<span><span class="co">#&gt;  2 mdp.390150… TOCQ… UNK       1 body        5 https:… http… "[[\…  2.02e7 Demo…</span></span>
<span><span class="co">#&gt;  3 mdp.390150… DE    UNK       1 body        5 https:… http… "[[\…  2.02e7 Demo…</span></span>
<span><span class="co">#&gt;  4 mdp.390150… IN    IN        1 body        9 https:… http… "[[\…  2.02e7 Demo…</span></span>
<span><span class="co">#&gt;  5 mdp.390150… Gold… NNP       1 body        9 https:… http… "[[\…  2.02e7 Demo…</span></span>
<span><span class="co">#&gt;  6 mdp.390150… *     SYM       4 body        9 https:… http… "[[\…  2.02e7 Demo…</span></span>
<span><span class="co">#&gt;  7 mdp.390150… Arth… NNP       1 body        9 https:… http… "[[\…  2.02e7 Demo…</span></span>
<span><span class="co">#&gt;  8 mdp.390150… DEMO… NNP       1 body        9 https:… http… "[[\…  2.02e7 Demo…</span></span>
<span><span class="co">#&gt;  9 mdp.390150… THE   DT        1 body        9 https:… http… "[[\…  2.02e7 Demo…</span></span>
<span><span class="co">#&gt; 10 mdp.390150… Tran… VBN       1 body        9 https:… http… "[[\…  2.02e7 Demo…</span></span>
<span><span class="co">#&gt; # … with 3,318,769 more rows, 33 more variables: contributor &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   pubDate &lt;int&gt;, publisher &lt;chr&gt;, pubPlace &lt;chr&gt;, language &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   accessRights &lt;chr&gt;, accessProfile &lt;chr&gt;, sourceInstitution &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   mainEntityOfPage &lt;chr&gt;, lcc &lt;chr&gt;, lccn &lt;chr&gt;, oclc &lt;chr&gt;, category &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   isbn &lt;chr&gt;, genre &lt;chr&gt;, typeOfResource &lt;chr&gt;, lastRightsUpdateDate &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   enumerationChronology &lt;chr&gt;, alternateTitle &lt;lgl&gt;, seq &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   version &lt;chr&gt;, tokenCount &lt;int&gt;, lineCount &lt;int&gt;, emptyLineCount &lt;int&gt;, …</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names</span></span></code></pre></div>
<p>Note that <code><a href="../reference/cache_htids.html">cache_htids()</a></code> automatically caches not only the extracted features file, but also the volume-level and page-level metadata; the function <code><a href="../reference/read_cached_htids.html">read_cached_htids()</a></code> by default adds both of these forms of metadata to your data frame. But we can also extract the page-level and volume-level metadata separately:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">tocqueville_ef</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_cached_htids.html">read_cached_htids</a></span><span class="op">(</span><span class="va">tocqueville4</span>, cache_type <span class="op">=</span> <span class="st">"ef"</span><span class="op">)</span></span>
<span><span class="va">tocqueville_meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_cached_htids.html">read_cached_htids</a></span><span class="op">(</span><span class="va">tocqueville4</span>, cache_type <span class="op">=</span> <span class="st">"meta"</span><span class="op">)</span></span>
<span><span class="va">tocqueville_pagemeta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_cached_htids.html">read_cached_htids</a></span><span class="op">(</span><span class="va">tocqueville4</span>, cache_type <span class="op">=</span> <span class="st">"pagemeta"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tocqueville_ef</span></span>
<span><span class="co">#&gt; # A tibble: 3,318,779 × 6</span></span>
<span><span class="co">#&gt;    htid               token       POS   count section  page</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;              &lt;chr&gt;       &lt;chr&gt; &lt;int&gt; &lt;chr&gt;   &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1 mdp.39015058109706 ALEXIS      UNK       1 body        5</span></span>
<span><span class="co">#&gt;  2 mdp.39015058109706 TOCQUEVILLE UNK       1 body        5</span></span>
<span><span class="co">#&gt;  3 mdp.39015058109706 DE          UNK       1 body        5</span></span>
<span><span class="co">#&gt;  4 mdp.39015058109706 IN          IN        1 body        9</span></span>
<span><span class="co">#&gt;  5 mdp.39015058109706 Goldhammer  NNP       1 body        9</span></span>
<span><span class="co">#&gt;  6 mdp.39015058109706 *           SYM       4 body        9</span></span>
<span><span class="co">#&gt;  7 mdp.39015058109706 Arthur      NNP       1 body        9</span></span>
<span><span class="co">#&gt;  8 mdp.39015058109706 DEMOCRACY   NNP       1 body        9</span></span>
<span><span class="co">#&gt;  9 mdp.39015058109706 THE         DT        1 body        9</span></span>
<span><span class="co">#&gt; 10 mdp.39015058109706 Translated  VBN       1 body        9</span></span>
<span><span class="co">#&gt; # … with 3,318,769 more rows</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span>
<span><span class="va">tocqueville_meta</span></span>
<span><span class="co">#&gt; # A tibble: 27 × 25</span></span>
<span><span class="co">#&gt;    htid        schem…¹ id    type  dateC…² title contr…³ pubDate publi…⁴ pubPl…⁵</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;       &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;     &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;  </span></span>
<span><span class="co">#&gt;  1 mdp.390150… https:… http… "[[\…  2.02e7 Demo… "[{\"i…    2004 "[{\"i… "{\"id…</span></span>
<span><span class="co">#&gt;  2 ien.355560… https:… http… "[[\…  2.02e7 Demo… "[{\"i…    2010 "{\"id… "{\"id…</span></span>
<span><span class="co">#&gt;  3 uc1.b39874… https:… http… "[[\…  2.02e7 Demo… "[{\"i…    1969 "{\"id… "{\"id…</span></span>
<span><span class="co">#&gt;  4 mdp.390150… https:… http… "[[\…  2.02e7 Demo… "[{\"i…    1981 "{\"id… "{\"id…</span></span>
<span><span class="co">#&gt;  5 uva.x00091… https:… http… "[[\…  2.02e7 Demo… "[{\"i…    1952 "{\"id… "{\"id…</span></span>
<span><span class="co">#&gt;  6 uva.x00084… https:… http… "[[\…  2.02e7 Demo… "[{\"i…    1959 "{\"id… "{\"id…</span></span>
<span><span class="co">#&gt;  7 uc1.321060… https:… http… "[[\…  2.02e7 Demo… "{\"id…    1961 "{\"id… "{\"id…</span></span>
<span><span class="co">#&gt;  8 uc1.311580… https:… http… "[[\…  2.02e7 Demo… "[{\"i…    1986 "{\"id… "{\"id…</span></span>
<span><span class="co">#&gt;  9 uc1.321060… https:… http… "[[\…  2.02e7 Demo… "[{\"i…    1980 "{\"id… "{\"id…</span></span>
<span><span class="co">#&gt; 10 mdp.390150… https:… http… "[[\…  2.02e7 Demo… "[{\"i…    1980 "{\"id… "{\"id…</span></span>
<span><span class="co">#&gt; # … with 17 more rows, 15 more variables: language &lt;chr&gt;, accessRights &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   accessProfile &lt;chr&gt;, sourceInstitution &lt;chr&gt;, mainEntityOfPage &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   lcc &lt;chr&gt;, lccn &lt;chr&gt;, oclc &lt;chr&gt;, category &lt;chr&gt;, isbn &lt;chr&gt;, genre &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   typeOfResource &lt;chr&gt;, lastRightsUpdateDate &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   enumerationChronology &lt;chr&gt;, alternateTitle &lt;lgl&gt;, and abbreviated variable</span></span>
<span><span class="co">#&gt; #   names ¹​schemaVersion, ²​dateCreated, ³​contributor, ⁴​publisher, ⁵​pubPlace</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names</span></span>
<span><span class="va">tocqueville_pagemeta</span></span>
<span><span class="co">#&gt; # A tibble: 28,492 × 17</span></span>
<span><span class="co">#&gt;    htid       page seq   version token…¹ lineC…² empty…³ sente…⁴ calcu…⁵ secti…⁶</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;     &lt;int&gt; &lt;chr&gt; &lt;chr&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt;   &lt;int&gt; &lt;chr&gt;     &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1 mdp.3901…     5 0000… af2e37…       3       1       0      NA so            3</span></span>
<span><span class="co">#&gt;  2 mdp.3901…     9 0000… 6cb0ed…      20       8       0       1 en           20</span></span>
<span><span class="co">#&gt;  3 mdp.3901…    10 0000… 12a1f3…     139      20       0       6 en          139</span></span>
<span><span class="co">#&gt;  4 mdp.3901…    11 0000… 7338b1…      20       5       0       3 en           20</span></span>
<span><span class="co">#&gt;  5 mdp.3901…    13 0000… 8a3246…      52       9       0       1 en           52</span></span>
<span><span class="co">#&gt;  6 mdp.3901…    15 0000… 7ca902…     272      33       0      16 en            1</span></span>
<span><span class="co">#&gt;  7 mdp.3901…    15 0000… 7ca902…     272      33       0      16 en          271</span></span>
<span><span class="co">#&gt;  8 mdp.3901…    16 0000… ce432e…     261      33       0       8 en          261</span></span>
<span><span class="co">#&gt;  9 mdp.3901…    17 0000… c7c8d5…     224      35       0       2 en            2</span></span>
<span><span class="co">#&gt; 10 mdp.3901…    17 0000… c7c8d5…     224      35       0       2 en          222</span></span>
<span><span class="co">#&gt; # … with 28,482 more rows, 7 more variables: sectionLineCount &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   sectionEmptyLineCount &lt;int&gt;, sectionSentenceCount &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   sectionCapAlphaSeq &lt;int&gt;, sectionBeginCharCount &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   sectionEndCharCount &lt;chr&gt;, section &lt;chr&gt;, and abbreviated variable names</span></span>
<span><span class="co">#&gt; #   ¹​tokenCount, ²​lineCount, ³​emptyLineCount, ⁴​sentenceCount,</span></span>
<span><span class="co">#&gt; #   ⁵​calculatedLanguage, ⁶​sectionTokenCount</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="creating-a-document-term-matrix-and-fitting-the-model">Creating a document-term matrix and fitting the model<a class="anchor" aria-label="anchor" href="#creating-a-document-term-matrix-and-fitting-the-model"></a>
</h4>
<p>This large data frame can be converted into a <code>quanteda::dfm()</code> document-feature matrix using the <a href="https://github.com/juliasilge/tidytext" class="external-link">tidytext</a> package (with each page a different document). Here we filter the data frame so that it contains only nouns (POS = “NN” or “NNP” or “NOUN”) in the “body” section of the page, excluding all strings smaller than 3 characters and all pages that end up with fewer than 10 tokens. We will use the results to calculate a per-page topic model.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/juliasilge/tidytext" class="external-link">tidytext</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://quanteda.io" class="external-link">quanteda</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">tocqueville_meta</span> <span class="op">&lt;-</span> <span class="va">tocqueville_meta</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">rowwise</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>contributor <span class="op">=</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">contributor</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu">pluck</span><span class="op">(</span><span class="st">"name"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>,</span>
<span>         publisher <span class="op">=</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">publisher</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>              <span class="fu">pluck</span><span class="op">(</span><span class="st">"name"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>,</span>
<span>         editor <span class="op">=</span> <span class="fu">str_remove</span><span class="op">(</span><span class="va">contributor</span>, <span class="st">"Tocqueville, Alexis de, 1805-1859.?, "</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>           <span class="fu">str_extract_all</span><span class="op">(</span><span class="st">"Goldhammer|Schleifer|Nolla|Mayer|Bender|Commager|Reeve|Bowen|Bradley|Boorstin"</span>, </span>
<span>                           simplify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>,</span>
<span>         short_publisher <span class="op">=</span> <span class="fu">str_extract</span><span class="op">(</span><span class="va">publisher</span>, <span class="st">"Knopf|Vintage|Britannica|Schocken |Sever &amp; Francis|Oxford|Modern Library|Liberty Fund|Doubleday|Library of America"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>,</span>
<span>         edition <span class="op">=</span> <span class="fu">str_c</span><span class="op">(</span><span class="va">short_publisher</span>, <span class="st">" ("</span>, <span class="va">editor</span>, <span class="st">") "</span>, </span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">enumerationChronology</span><span class="op">)</span>, <span class="st">""</span>, <span class="fu">str_to_lower</span><span class="op">(</span><span class="fu">str_remove</span><span class="op">(</span><span class="va">enumerationChronology</span>, </span>
<span>                                                                                          <span class="st">" "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>           <span class="fu">str_remove</span><span class="op">(</span><span class="st">" \\(\\)"</span><span class="op">)</span>,</span>
<span>         volume <span class="op">=</span> <span class="fu">parse_number</span><span class="op">(</span><span class="va">enumerationChronology</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tocqueville_meta</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">htid</span>, <span class="va">pubDate</span>, <span class="va">edition</span>, <span class="va">volume</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 27 × 4</span></span>
<span><span class="co">#&gt;    htid               pubDate edition                               volume</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;                &lt;int&gt; &lt;chr&gt;                                  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 mdp.39015058109706    2004 "Library of America (Goldhammer) "        NA</span></span>
<span><span class="co">#&gt;  2 ien.35556040838641    2010 "Liberty Fund (Schleifer, Nolla) v.1"      1</span></span>
<span><span class="co">#&gt;  3 uc1.b3987464          1969 "Doubleday (Mayer) "                      NA</span></span>
<span><span class="co">#&gt;  4 mdp.39015059568017    1981 "Modern Library (Bender) "                NA</span></span>
<span><span class="co">#&gt;  5 uva.x000918570        1952 "Oxford (Commager, Reeve) "               NA</span></span>
<span><span class="co">#&gt;  6 uva.x000843187        1959 "Oxford (Commager, Reeve) "               NA</span></span>
<span><span class="co">#&gt;  7 uc1.32106006021593    1961 "Schocken  v.1"                            1</span></span>
<span><span class="co">#&gt;  8 uc1.31158011108353    1986 "Sever &amp; Francis (Reeve) v.1"              1</span></span>
<span><span class="co">#&gt;  9 uc1.32106009996031    1980 "Knopf (Bowen, Reeve, Bradley) v.1"        1</span></span>
<span><span class="co">#&gt; 10 mdp.39015001795965    1980 "Knopf (Bowen, Reeve, Bradley) v.1"        1</span></span>
<span><span class="co">#&gt; # … with 17 more rows</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">tocqueville_ef</span> <span class="op">&lt;-</span> <span class="va">tocqueville_ef</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">section</span> <span class="op">==</span> <span class="st">"body"</span>, <span class="op">!</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">token</span>, <span class="st">"[^[:alnum:]]"</span><span class="op">)</span>,</span>
<span>         <span class="fu">str_detect</span><span class="op">(</span><span class="va">POS</span>, <span class="st">"NN|NOUN"</span><span class="op">)</span>, <span class="fu">str_length</span><span class="op">(</span><span class="va">token</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>text_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">htid</span>, <span class="va">page</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">text_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>num_tokens <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">htid</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>prop_page <span class="op">=</span> <span class="va">page</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">page</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">num_tokens</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># This selects pages with at least 10 tokens</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">tocqueville_meta</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">tocqueville_pagemeta</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">calculatedLanguage</span> <span class="op">==</span> <span class="st">"en"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tocqueville_dfm</span> <span class="op">&lt;-</span> <span class="va">tocqueville_ef</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">cast_dfm</span><span class="op">(</span><span class="va">text_id</span>, <span class="va">token</span>, <span class="va">count</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">docvars</span><span class="op">(</span><span class="va">tocqueville_dfm</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tocqueville_ef</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">token</span>, <span class="op">-</span><span class="va">POS</span>, <span class="op">-</span><span class="va">count</span>, <span class="op">-</span><span class="va">section</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tocqueville_dfm</span></span>
<span><span class="co">#&gt; Document-feature matrix of: 14,442 documents, 28,562 features (99.76% sparse) and 47 docvars.</span></span>
<span><span class="co">#&gt;                        features</span></span>
<span><span class="co">#&gt; docs                    Putnam copyright Printing copying chronology Books All</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_10      1         1        1       1          1     1   1</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_13      0         0        0       0          0     0   0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_15      0         0        0       0          0     0   0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_16      0         0        0       0          0     0   0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_17      0         0        0       0          0     0   0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_18      0         0        0       0          0     0   0</span></span>
<span><span class="co">#&gt;                        features</span></span>
<span><span class="co">#&gt; docs                    permission Printed Number</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_10          1       1      1</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_13          0       0      0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_15          0       0      0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_16          0       0      0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_17          0       0      0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_18          0       0      0</span></span>
<span><span class="co">#&gt; [ reached max_ndoc ... 14,436 more documents, reached max_nfeat ... 28,552 more features ]</span></span></code></pre></div>
<p>We can use this document-feature matrix in a variety of ways. Here I train a page-level topic model using the <a href="http://www.structuraltopicmodel.com/" class="external-link">stm</a> package, using only the English texts of Tocqueville.</p>
<p>First we subset the document-feature matrix, lowercase its features, remove stopwords, and trim the vocabulary to the top 20,000 features.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tocqueville_dfm_eng</span> <span class="op">&lt;-</span> <span class="fu">dfm_tolower</span><span class="op">(</span><span class="va">tocqueville_dfm</span><span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dfm_trim</span><span class="op">(</span><span class="fl">20000</span>, termfreq_type <span class="op">=</span> <span class="st">"rank"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dfm_remove</span><span class="op">(</span><span class="fu">stopwords</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tocqueville_dfm_eng</span></span>
<span><span class="co">#&gt; Document-feature matrix of: 14,442 documents, 24,997 features (99.73% sparse) and 47 docvars.</span></span>
<span><span class="co">#&gt;                        features</span></span>
<span><span class="co">#&gt; docs                    putnam copyright printing copying chronology books</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_10      1         1        1       1          1     1</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_13      0         0        0       0          0     0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_15      0         0        0       0          0     0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_16      0         0        0       0          0     0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_17      0         0        0       0          0     0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_18      0         0        0       0          0     0</span></span>
<span><span class="co">#&gt;                        features</span></span>
<span><span class="co">#&gt; docs                    permission printed number penguin</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_10          1       1      1       2</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_13          0       0      0       0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_15          0       0      0       0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_16          0       0      0       0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_17          0       0      0       0</span></span>
<span><span class="co">#&gt;   mdp.39015058109706_18          0       0      0       0</span></span>
<span><span class="co">#&gt; [ reached max_ndoc ... 14,436 more documents, reached max_nfeat ... 24,987 more features ]</span></span></code></pre></div>
<p>We then fit a structural topic model with 20 topics. This takes a while; normally you’d also do some sensitivity analysis and check whether the model works better with more or fewer topics, but this model is only illustrative (see <a href="https://juliasilge.com/blog/evaluating-stm/" class="external-link">this very useful article by Julia Silge</a> on training, evaluating, and interpreting topic models). I also don’t incorporate any prevalence correlates, but this is trivial to do given that the metadata is incorporated into the document-feature matrix.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.structuraltopicmodel.com/" class="external-link">stm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">verbose</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">verbose</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">stm</span><span class="op">(</span><span class="va">tocqueville_dfm_eng</span>, K <span class="op">=</span> <span class="fl">20</span>, verbose <span class="op">=</span> <span class="va">verbose</span><span class="op">)</span></span></code></pre></div>
<p>We then tidy this model using the tidiers from the <a href="https://github.com/juliasilge/tidytext" class="external-link">tidytext</a> package.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tidy_model</span> <span class="op">&lt;-</span> <span class="fu">tidy</span><span class="op">(</span><span class="va">model</span>, matrix <span class="op">=</span> <span class="st">"gamma"</span>,</span>
<span>                   document_names <span class="op">=</span>  <span class="fu">docvars</span><span class="op">(</span><span class="va">tocqueville_dfm_eng</span><span class="op">)</span><span class="op">$</span><span class="va">text_id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">docs</span> <span class="op">&lt;-</span> <span class="fu">docvars</span><span class="op">(</span><span class="va">tocqueville_dfm_eng</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>document <span class="op">=</span> <span class="va">text_id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tidy_model</span> <span class="op">&lt;-</span> <span class="va">tidy_model</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">docs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu">labelTopics</span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">$</span><span class="va">prob</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">as_tibble</span><span class="op">(</span>.name_repair <span class="op">=</span> <span class="st">"unique"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"topic"</span>, values_to <span class="op">=</span> <span class="st">"word"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">topic</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">word</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>topic <span class="op">=</span> <span class="fu">str_remove</span><span class="op">(</span><span class="va">topic</span>, <span class="fu">fixed</span><span class="op">(</span><span class="st">"..."</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">topic</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tidy_model</span> <span class="op">&lt;-</span> <span class="va">tidy_model</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">labels</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tidy_model</span></span>
<span><span class="co">#&gt; # A tibble: 288,840 × 51</span></span>
<span><span class="co">#&gt;    docum…¹ topic   gamma htid   page text_id num_t…² prop_…³ schem…⁴ id    type </span></span>
<span><span class="co">#&gt;    &lt;chr&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt;     &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt;  1 mdp.39…     1 0.0746  mdp.…    10 mdp.39…      48  0.0104 https:… http… "[[\…</span></span>
<span><span class="co">#&gt;  2 mdp.39…     1 0.00442 mdp.…    13 mdp.39…      17  0.0135 https:… http… "[[\…</span></span>
<span><span class="co">#&gt;  3 mdp.39…     1 0.0330  mdp.…    15 mdp.39…      46  0.0156 https:… http… "[[\…</span></span>
<span><span class="co">#&gt;  4 mdp.39…     1 0.0862  mdp.…    16 mdp.39…      60  0.0166 https:… http… "[[\…</span></span>
<span><span class="co">#&gt;  5 mdp.39…     1 0.00436 mdp.…    17 mdp.39…      53  0.0176 https:… http… "[[\…</span></span>
<span><span class="co">#&gt;  6 mdp.39…     1 0.00726 mdp.…    18 mdp.39…      50  0.0187 https:… http… "[[\…</span></span>
<span><span class="co">#&gt;  7 mdp.39…     1 0.0107  mdp.…    19 mdp.39…      55  0.0197 https:… http… "[[\…</span></span>
<span><span class="co">#&gt;  8 mdp.39…     1 0.00459 mdp.…    20 mdp.39…      56  0.0207 https:… http… "[[\…</span></span>
<span><span class="co">#&gt;  9 mdp.39…     1 0.00812 mdp.…    23 mdp.39…      64  0.0239 https:… http… "[[\…</span></span>
<span><span class="co">#&gt; 10 mdp.39…     1 0.0117  mdp.…    24 mdp.39…      90  0.0249 https:… http… "[[\…</span></span>
<span><span class="co">#&gt; # … with 288,830 more rows, 40 more variables: dateCreated &lt;int&gt;, title &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   contributor &lt;chr&gt;, pubDate &lt;int&gt;, publisher &lt;chr&gt;, pubPlace &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   language &lt;chr&gt;, accessRights &lt;chr&gt;, accessProfile &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   sourceInstitution &lt;chr&gt;, mainEntityOfPage &lt;chr&gt;, lcc &lt;chr&gt;, lccn &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   oclc &lt;chr&gt;, category &lt;chr&gt;, isbn &lt;chr&gt;, genre &lt;chr&gt;, typeOfResource &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   lastRightsUpdateDate &lt;int&gt;, enumerationChronology &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   alternateTitle &lt;lgl&gt;, editor &lt;chr&gt;, short_publisher &lt;chr&gt;, edition &lt;chr&gt;, …</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names</span></span></code></pre></div>
<p>We can now visualize the topic distribution per book:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggtext/" class="external-link">ggtext</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">tidy_model</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>editions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">edition</span>, <span class="st">"HT#"</span>, <span class="va">htid</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">page</span>,  y <span class="op">=</span> <span class="va">gamma</span>, fill <span class="op">=</span> <span class="va">label</span><span class="op">)</span>,</span>
<span>           position <span class="op">=</span> <span class="st">"fill"</span>,</span>
<span>           width <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">editions</span><span class="op">~</span><span class="va">.</span>, switch <span class="op">=</span> <span class="st">'y'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># geom_vline(data = chapters, aes(xintercept = page)) +</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span></span>
<span>      panel.spacing.y<span class="op">=</span><span class="fu">unit</span><span class="op">(</span><span class="fl">0</span>, <span class="st">"lines"</span><span class="op">)</span>,</span>
<span>      strip.text.y.left <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span>, angle <span class="op">=</span> <span class="fl">0</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>      legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>      axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      axis.title.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      axis.ticks.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      panel.border <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      strip.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      plot.title <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      panel.grid<span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_discrete</span><span class="op">(</span>type <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">23</span>, palette <span class="op">=</span> <span class="st">"RdYlBu"</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Topic distribution in different volumes and editions of translations of Tocqueville's *Democracy in America*"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"page sequence"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="images/topic_models_using_hathi_ef-unnamed-chunk-18-1.png" alt=""><p class="caption">Figure 1</p>
</div>
<p>We can see here some broad patterns: volume 2 of <em>Democracy in America</em> has more “abstract” topics (about equality, power, virtue, science, etc.) than volume 1; abridgements preserve roughtly the distribution of topics of the non-abridged versions (except for sections at the very end); Schelifer and Nolla’s critical edition has facing-page French (which appears as missing pages, excluded from the analysis because the language is not English) and critical apparatus in footnotes (so the distribution of topics looks different); etc. More could be said here, but this is just a starting point!</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Xavier Marquez, Ben Schmidt.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
